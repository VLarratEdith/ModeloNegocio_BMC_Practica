<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Startup Challenge: Modelo de Negocio & Valor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --primary: #00f2ff;
            --secondary: #ff0055;
            --success: #00ff9d;
            --warning: #ffaa00;
            --text: #ffffff;
            --text-muted: #aaaaaa;
            --info-bg: #2a2a2a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-color); color: var(--text); line-height: 1.6; }
        
        .hidden { display: none !important; }
        
        .btn {
            background: linear-gradient(45deg, var(--primary), #0099ff);
            border: none; padding: 12px 24px; color: #000; font-weight: 900; cursor: pointer;
            border-radius: 50px; text-transform: uppercase; letter-spacing: 1px;
            transition: transform 0.2s, box-shadow 0.2s; margin: 5px;
        }
        .btn:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--primary); }
        .btn-secondary { background: linear-gradient(45deg, var(--secondary), #ff5500); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--text-muted); color: var(--text-muted); }
        .btn-outline:hover { border-color: var(--text); color: var(--text); }
        .btn-nav { padding: 10px 20px; font-size: 0.9rem; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { background: var(--card-bg); padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; border: 1px solid #333; }
        
        header { text-align: center; padding: 20px 0; }
        h1 { font-size: 2rem; text-transform: uppercase; background: -webkit-linear-gradient(var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .progress-bar { width: 100%; height: 10px; background: #333; border-radius: 5px; margin: 20px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.5s ease; }

        label { color: var(--primary); font-weight: bold; display: block; margin-top: 15px; font-size: 1.1rem; }
        .guide-question { color: var(--warning); font-size: 0.9rem; font-style: italic; margin: 5px 0 10px 0; display: block; }
        input, textarea { width: 100%; padding: 15px; margin: 10px 0; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 8px; font-family: inherit; }
        input:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 242, 255, 0.2); }

        .info-box {
            background: var(--info-bg);
            border-left: 4px solid var(--warning);
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: max-height 0.3s ease;
        }
        .info-box:hover { background: #333; }
        .info-box h4 { color: var(--warning); margin-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        .info-content { display: none; margin-top: 10px; color: var(--text-muted); border-top: 1px solid #444; padding-top: 10px; }
        .info-box.active .info-content { display: block; }
        .info-icon { transition: transform 0.3s; }
        .info-box.active .info-icon { transform: rotate(180deg); }

        .token-counter {
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
            border: 2px solid var(--primary);
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
        }
        .token-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .token-stat { background: rgba(0, 242, 255, 0.1); padding: 10px; border-radius: 8px; text-align: center; }
        .token-stat-value { font-size: 1.2rem; font-weight: 900; color: var(--primary); }
        .token-stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }

        #ai-feedback { background: #2a2a2a; padding: 15px; border-left: 4px solid var(--secondary); margin-top: 15px; border-radius: 4px; font-style: italic; min-height: 60px; }
        .typing-indicator::after { content: '...'; animation: typing 1.5s infinite; }
        @keyframes typing { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } }

        .empathy-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .empathy-box { background: #2a2a2a; padding: 20px; border-radius: 10px; border: 2px solid var(--primary); }
        .empathy-box h4 { color: var(--primary); margin-bottom: 15px; font-size: 1.1rem; }
        .empathy-box.center { grid-column: 1 / -1; background: var(--secondary); text-align: center; }
        
        .archetype-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .archetype-section { background: #2a2a2a; padding: 20px; border-radius: 10px; }
        .archetype-section h4 { color: var(--warning); margin-bottom: 15px; }

        #bmc-preview { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            grid-template-rows: repeat(2, 1fr); 
            gap: 5px; 
            background: white; 
            color: black; 
            padding: 10px; 
            border-radius: 5px; 
            margin-top: 20px; 
            height: 600px;
        }
        .bmc-block { 
            background: #f9f9f9; 
            padding: 8px; 
            border: 1px solid #ccc; 
            font-size: 0.7rem; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }
        .bmc-block h4 { 
            color: #333; 
            border-bottom: 2px solid var(--secondary); 
            padding-bottom: 3px; 
            margin-bottom: 5px; 
            font-size: 0.8rem; 
            text-transform: uppercase;
        }
        .bmc-block ul { padding-left: 15px; margin: 0; }
        .bmc-block li { margin-bottom: 3px; }
        
        .bmc-socios { grid-column: 1 / 2; grid-row: 1 / 2; }
        .bmc-actividades { grid-column: 1 / 2; grid-row: 2 / 3; }
        .bmc-recursos { grid-column: 2 / 3; grid-row: 1 / 3; }
        .bmc-propuesta { grid-column: 3 / 4; grid-row: 1 / 3; background: #e3f2fd; border: 2px solid #2196f3; }
        .bmc-relaciones { grid-column: 4 / 5; grid-row: 1 / 2; }
        .bmc-canales { grid-column: 4 / 5; grid-row: 2 / 3; }
        .bmc-segmentos { grid-column: 5 / 6; grid-row: 1 / 3; }
        .bmc-costes { grid-column: 1 / 4; grid-row: 3 / 4; height: 100px; }
        .bmc-ingresos { grid-column: 4 / 6; grid-row: 3 / 4; height: 100px; }

        .story-box { border-left: 5px solid var(--primary); padding-left: 20px; margin-bottom: 20px; background: rgba(0, 242, 255, 0.05); padding: 20px; border-radius: 0 10px 10px 0; }
        .badge { display: inline-block; background: var(--secondary); color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 10px; }

        #api-setup { text-align: center; max-width: 600px; margin: 50px auto; }
        
        .nav-bar { display: flex; justify-content: space-between; margin-top: 30px; border-top: 1px solid #333; padding-top: 20px; }

        @media (max-width: 768px) {
            .token-stats { grid-template-columns: 1fr 1fr; }
            .empathy-grid, .archetype-grid { grid-template-columns: 1fr; }
            #bmc-preview { grid-template-columns: 1fr; grid-template-rows: auto; height: auto; }
            .bmc-socios, .bmc-actividades, .bmc-recursos, .bmc-propuesta, .bmc-relaciones, .bmc-canales, .bmc-segmentos, .bmc-costes, .bmc-ingresos { grid-column: auto; grid-row: auto; min-height: 100px; }
            .nav-bar { flex-direction: column; gap: 10px; }
            .nav-bar button { width: 100%; }
        }
    </style>
</head>
<body>

    <div id="api-setup" class="container">
        <div class="card">
            <h1><i class="fas fa-robot"></i> Startup Challenge</h1>
            <p>Bienvenido, emprendedor. Configura tu entorno para comenzar.</p>
            
            <div class="info-box active" style="border-left-color: var(--primary);">
                <h4><i class="fas fa-info-circle"></i> ¿Qué es esto?</h4>
                <div class="info-content" style="display: block;">
                    Usaremos Inteligencia Artificial (Qwen) como mentor. Necesitas una API Key gratuita de Alibaba Cloud DashScope.
                </div>
            </div>

            <label>Introduce tu Qwen API Key:</label>
            <input type="password" id="api-key" placeholder="sk-...">
            
            <label>Límite de Tokens (Free Tier):</label>
            <input type="number" id="token-limit" value="100000">
            
            <p style="font-size: 0.8rem; color: #888; margin: 15px 0;">Tu clave se guarda solo en tu navegador.</p>
            
            <button class="btn" onclick="saveApiKey()">Comenzar Aventura</button>
            <br><br>
            <button class="btn btn-outline" onclick="startDemoMode()">Modo Simulación (Sin IA)</button>
        </div>
    </div>

    <div id="game-app" class="container hidden">
        <header>
            <h1>Startup Challenge</h1>
            <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
            <p id="step-indicator">Fase 1: El Desafío</p>
        </header>

        <div class="token-counter">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4><i class="fas fa-coins"></i> Consumo API</h4>
                <button class="btn-outline btn-small" onclick="resetTokenCounter()">Reiniciar</button>
            </div>
            <div class="token-stats">
                <div class="token-stat"><div class="token-stat-value" id="tokens-used">0</div><div class="token-stat-label">Usados</div></div>
                <div class="token-stat"><div class="token-stat-value" id="tokens-remaining">100k</div><div class="token-stat-label">Restantes</div></div>
                <div class="token-stat"><div class="token-stat-value" id="tokens-percent">0%</div><div class="token-stat-label">Consumo</div></div>
                <div class="token-stat"><div class="token-stat-value" id="api-calls">0</div><div class="token-stat-label">Llamadas</div></div>
            </div>
        </div>

        <!-- FASE 1: STORYTELLING ALEATORIO -->
        <div id="step-1" class="step-section">
            <div class="card">
                <span class="badge">Misión 1</span>
                <h2>El Desafío Inicial</h2>
                <div class="story-box" id="story-content"></div>
                
                <div class="info-box" onclick="toggleInfo(this)">
                    <h4><i class="fas fa-lightbulb"></i> Definición: Idea de Negocio <i class="fas fa-chevron-down info-icon"></i></h4>
                    <div class="info-content">
                        <p><strong>Definición:</strong> Descripción de una oportunidad de mercado para ofrecer un producto/servicio que satisfaga una necesidad.</p>
                        <p><strong>Importancia:</strong> Debe ser viable, rentable e innovadora.</p>
                    </div>
                </div>

                <label>Nombre de tu Startup:</label>
                <input type="text" id="startup-name" placeholder="Ej: EcoWater Solutions">
                
                <div id="ai-feedback-1" class="hidden"></div>
                <button class="btn" onclick="consultAI(1, 'Intro')">Validar Nombre con IA</button>
            </div>
        </div>

        <!-- FASE 2: ARQUETIPO DEL CLIENTE -->
        <div id="step-2" class="step-section hidden">
            <div class="card">
                <span class="badge">Misión 2</span>
                <h2>Arquetipo del Cliente Objetivo</h2>
                
                <div class="info-box" onclick="toggleInfo(this)">
                    <h4><i class="fas fa-user"></i> ¿Qué es el Arquetipo del Cliente? <i class="fas fa-chevron-down info-icon"></i></h4>
                    <div class="info-content">
                        <p><strong>Definición:</strong> Representación ficticia y detallada del cliente ideal. Humaniza al cliente para entender sus características y comportamientos.</p>
                        <p><strong>Importancia:</strong> Permite personalizar la estrategia de marketing y ventas para satisfacer necesidades específicas.</p>
                    </div>
                </div>

                <div class="archetype-grid">
                    <div class="archetype-section">
                        <h4><i class="fas fa-chart-bar"></i> Datos Demográficos</h4>
                        <label>Edad y Género
                            <span class="guide-question">¿Qué rango de edad tiene? ¿Qué género predomina?</span>
                        </label>
                        <input type="text" id="arch-age" placeholder="Ej: 25-35 años, ambos géneros">
                        
                        <label>Nivel Educativo e Ingresos
                            <span class="guide-question">¿Qué nivel educativo tiene? ¿Cuál es su nivel de ingresos?</span>
                        </label>
                        <input type="text" id="arch-education" placeholder="Ej: Universitario, ingresos medios">
                        
                        <label>Ocupación y Estado Civil
                            <span class="guide-question">¿A qué se dedica? ¿Cuál es su situación familiar?</span>
                        </label>
                        <input type="text" id="arch-job" placeholder="Ej: Profesional independiente, soltero">
                    </div>

                    <div class="archetype-section">
                        <h4><i class="fas fa-brain"></i> Datos Psicográficos</h4>
                        <label>Personalidad y Valores
                            <span class="guide-question">¿Cómo es su personalidad? ¿Qué valores le importan?</span>
                        </label>
                        <input type="text" id="arch-personality" placeholder="Ej: Innovador, valora la sostenibilidad">
                        
                        <label>Intereses y Estilo de Vida
                            <span class="guide-question">¿Qué le gusta hacer? ¿Cómo vive su día a día?</span>
                        </label>
                        <input type="text" id="arch-lifestyle" placeholder="Ej: Le gusta la tecnología, vida activa">
                    </div>

                    <div class="archetype-section">
                        <h4><i class="fas fa-shopping-cart"></i> Hábitos de Compra</h4>
                        <label>¿Cómo y Dónde Compra?
                            <span class="guide-question">¿Compra online o presencial? ¿Con qué frecuencia?</span>
                        </label>
                        <input type="text" id="arch-buy-how" placeholder="Ej: Compra online, 2-3 veces al mes">
                        
                        <label>Factores que Influyen
                            <span class="guide-question">¿Qué le motiva a comprar? ¿Quién influye en su decisión?</span>
                        </label>
                        <input type="text" id="arch-buy-why" placeholder="Ej: Precio, calidad, recomendaciones">
                    </div>

                    <div class="archetype-section">
                        <h4><i class="fas fa-bullseye"></i> Necesidades y Expectativas</h4>
                        <label>Necesidades Principales
                            <span class="guide-question">¿Qué problemas quiere resolver? ¿Qué necesita?</span>
                        </label>
                        <input type="text" id="arch-needs" placeholder="Ej: Ahorrar tiempo, mejorar productividad">
                        
                        <label>Expectativas del Producto
                            <span class="guide-question">¿Qué espera de tu solución? ¿Qué le haría feliz?</span>
                        </label>
                        <input type="text" id="arch-expectations" placeholder="Ej: Facilidad de uso, buen servicio">
                    </div>
                </div>

                <div id="ai-feedback-2" class="hidden"></div>
                <button class="btn" onclick="consultAI(2, 'Archetype')">Validar Arquetipo con IA</button>
            </div>
        </div>

        <!-- FASE 3: MAPA DE EMPATÍA -->
        <div id="step-3" class="step-section hidden">
            <div class="card">
                <span class="badge">Misión 3</span>
                <h2>Mapa de Empatía del Cliente</h2>
                
                <div class="info-box" onclick="toggleInfo(this)">
                    <h4><i class="fas fa-heart"></i> ¿Qué es el Mapa de Empatía? <i class="fas fa-chevron-down info-icon"></i></h4>
                    <div class="info-content">
                        <p><strong>Definición:</strong> Herramienta visual que permite comprender los pensamientos, sentimientos, motivaciones y comportamientos del cliente.</p>
                        <p><strong>Importancia:</strong> Al empatizar con el cliente, entendemos su verdadero problema y lo que está experimentando.</p>
                    </div>
                </div>

                <div class="empathy-grid">
                    <div class="empathy-box">
                        <h4><i class="fas fa-thought"></i> ¿Qué PIENSA y SIENTE?</h4>
                        <label>Sus Pensamientos y Emociones
                            <span class="guide-question">¿Qué le preocupa? ¿Qué le motiva? ¿Qué sueños tiene?</span>
                        </label>
                        <textarea id="empathy-think" rows="3" placeholder="Ej: Le preocupa no tener tiempo suficiente, sueña con..."></textarea>
                    </div>

                    <div class="empathy-box">
                        <h4><i class="fas fa-comments"></i> ¿Qué DICE y HACE?</h4>
                        <label>Su Comportamiento y Actitud
                            <span class="guide-question">¿Cómo se comporta? ¿Qué dice a otros? ¿Qué hace para resolver su problema?</span>
                        </label>
                        <textarea id="empathy-say" rows="3" placeholder="Ej: Se queja de..., busca información en..."></textarea>
                    </div>

                    <div class="empathy-box center">
                        <h4><i class="fas fa-user-circle" style="font-size: 3rem;"></i></h4>
                        <h3 id="empathy-client-name">CLIENTE OBJETIVO</h3>
                        <p style="margin-top: 10px;">Nombre del arquetipo definido</p>
                    </div>

                    <div class="empathy-box">
                        <h4><i class="fas fa-eye"></i> ¿Qué VE?</h4>
                        <label>Su Entorno Visual
                            <span class="guide-question">¿Qué ve en su entorno? ¿Qué ofrecen los competidores? ¿Qué hacen sus amigos?</span>
                        </label>
                        <textarea id="empathy-see" rows="3" placeholder="Ej: Ve mucha publicidad de..., sus amigos usan..."></textarea>
                    </div>

                    <div class="empathy-box">
                        <h4><i class="fas fa-ear-listen"></i> ¿Qué OYE?</h4>
                        <label>Influencias del Entorno
                            <span class="guide-question">¿Qué le dicen amigos/familia? ¿Qué escucha en redes? ¿Qué influencers sigue?</span>
                        </label>
                        <textarea id="empathy-hear" rows="3" placeholder="Ej: Sus amigos le recomiendan..., escucha que..."></textarea>
                    </div>

                    <div class="empathy-box">
                        <h4><i class="fas fa-heart-crack"></i> SUS DOLORES (Pains)</h4>
                        <label>Problemas y Frustraciones
                            <span class="guide-question">¿Qué le frustra? ¿Qué obstáculos tiene? ¿Qué riesgos teme?</span>
                        </label>
                        <textarea id="empathy-pains" rows="3" placeholder="Ej: Pierde mucho tiempo, le resulta caro, tiene miedo de..."></textarea>
                    </div>

                    <div class="empathy-box">
                        <h4><i class="fas fa-heart"></i> SUS GANANCIAS (Gains)</h4>
                        <label>Deseos y Beneficios Esperados
                            <span class="guide-question">¿Qué quiere lograr? ¿Qué beneficios espera? ¿Qué le haría feliz?</span>
                        </label>
                        <textarea id="empathy-gains" rows="3" placeholder="Ej: Ahorrar tiempo, ganar estatus, sentirse seguro..."></textarea>
                    </div>
                </div>

                <div id="ai-feedback-3" class="hidden"></div>
                <button class="btn" onclick="consultAI(3, 'Empathy')">Validar Mapa de Empatía con IA</button>
            </div>
        </div>

        <!-- FASE 4: PERFIL DEL CLIENTE (VPC) -->
        <div id="step-4" class="step-section hidden">
            <div class="card">
                <span class="badge">Misión 4</span>
                <h2>Perfil del Cliente (Value Proposition Canvas)</h2>
                
                <div class="info-box" onclick="toggleInfo(this)">
                    <h4><i class="fas fa-user"></i> Definición: Perfil del Cliente <i class="fas fa-chevron-down info-icon"></i></h4>
                    <div class="info-content">
                        <p><strong>Definición:</strong> Describe de manera estructurada un segmento de clientes específico.</p>
                        <p><strong>Componentes:</strong> Trabajos (Jobs), Frustraciones (Pains), Alegrías (Gains).</p>
                    </div>
                </div>

                <label>Trabajos del Cliente (Jobs)
                    <span class="guide-question">¿Qué intenta lograr en su vida laboral o personal? ¿Qué tareas quiere terminar? ¿Qué problemas quiere solucionar?</span>
                </label>
                <textarea id="cust-jobs" rows="3" placeholder="Ej: Mantener su huerto urbano vivo sin gastar mucha agua..."></textarea>
                
                <label>Frustraciones (Pains)
                    <span class="guide-question">¿Qué le molesta antes, durante y después de intentar resolver un trabajo? ¿Qué obstáculos tiene? ¿Qué riesgos teme?</span>
                </label>
                <textarea id="cust-pains" rows="3" placeholder="Ej: Miedo a que las plantas mueran, facturas de agua altas..."></textarea>
                
                <label>Alegrías (Gains)
                    <span class="guide-question">¿Qué resultados y beneficios quiere? ¿Qué le haría feliz? ¿Qué ahorros valoraría?</span>
                </label>
                <textarea id="cust-gains" rows="3" placeholder="Ej: Ahorrar dinero, sentirse ecológico, comer sano..."></textarea>

                <div id="ai-feedback-4" class="hidden"></div>
                <button class="btn" onclick="consultAI(4, 'VPC')">Validar Perfil con IA</button>
            </div>
        </div>

        <!-- FASE 5: PROPUESTA DE VALOR -->
        <div id="step-5" class="step-section hidden">
            <div class="card">
                <span class="badge">Misión 5</span>
                <h2>Mapa de Valor (Propuesta)</h2>
                
                <div class="info-box" onclick="toggleInfo(this)">
                    <h4><i class="fas fa-gem"></i> Definición: Mapa de Valor <i class="fas fa-chevron-down info-icon"></i></h4>
                    <div class="info-content">
                        <p><strong>Definición:</strong> Describe las características de tu propuesta de valor específica.</p>
                        <p><strong>Componentes:</strong> Productos/Servicios, Aliviadores de Frustraciones, Creadores de Alegrías.</p>
                    </div>
                </div>

                <label>Productos y Servicios
                    <span class="guide-question">¿Qué productos o servicios ofreces? ¿Qué características tienen?</span>
                </label>
                <input type="text" id="val-prod" placeholder="Ej: Sistema de riego automático con IA...">
                
                <label>Aliviadores de Dolores
                    <span class="guide-question">¿Cómo alivias las frustraciones del cliente? ¿Qué problemas resuelves?</span>
                </label>
                <textarea id="val-pains" rows="2" placeholder="Ej: Reduce el consumo de agua un 90%..."></textarea>
                
                <label>Creadores de Alegrías
                    <span class="guide-question">¿Cómo creas las alegrías que el cliente espera? ¿Qué beneficios adicionales ofreces?</span>
                </label>
                <textarea id="val-gains" rows="2" placeholder="Ej: App para monitorizar plantas desde el móvil..."></textarea>

                <div id="ai-feedback-5" class="hidden"></div>
                <button class="btn" onclick="consultAI(5, 'Propuesta')">Validar Encaje (Fit)</button>
            </div>
        </div>

        <!-- FASE 6: BUSINESS MODEL CANVAS -->
        <div id="step-6" class="step-section hidden">
            <div class="card">
                <span class="badge">Misión 6</span>
                <h2>Business Model Canvas (9 Bloques)</h2>
                
                <div class="info-box" onclick="toggleInfo(this)">
                    <h4><i class="fas fa-th-large"></i> Definición: BMC <i class="fas fa-chevron-down info-icon"></i></h4>
                    <div class="info-content">
                        <p><strong>Definición:</strong> Herramienta visual con 9 bloques que describe la lógica de cómo una organización crea, entrega y captura valor.</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label>Segmentos de Clientes
                            <span class="guide-question">¿Quiénes son los clientes? ¿Puede describir los diferentes tipos de clientes? ¿En qué difieren los segmentos?</span>
                        </label>
                        <input type="text" id="bmc-segmentos">
                        
                        <label>Canales de Distribución
                            <span class="guide-question">¿Cómo llega a los clientes y cómo los conquista? ¿A través de cuáles canales interactúa con los clientes?</span>
                        </label>
                        <input type="text" id="bmc-canales">
                        
                        <label>Relaciones con Clientes
                            <span class="guide-question">¿Qué tipo de relaciones construye con los clientes? ¿Tiene una estrategia de gestión de relaciones?</span>
                        </label>
                        <input type="text" id="bmc-relaciones">
                        
                        <label>Fuentes de Ingresos
                            <span class="guide-question">¿Cuál es la estructura de sus ingresos? ¿Cómo gana dinero en el negocio? ¿Qué tipo de ingresos recibe?</span>
                        </label>
                        <input type="text" id="bmc-ingresos">
                    </div>
                    <div>
                        <label>Recursos Clave
                            <span class="guide-question">¿Cuáles son los recursos más importantes y costosos? (Personas, redes, instalaciones, competencias...)</span>
                        </label>
                        <input type="text" id="bmc-recursos">
                        
                        <label>Actividades Clave
                            <span class="guide-question">¿Cuáles son las actividades y procesos clave en el modelo de negocio?</span>
                        </label>
                        <input type="text" id="bmc-actividades">
                        
                        <label>Socios Clave (Alianzas)
                            <span class="guide-question">¿Quiénes son los aliados estratégicos más importantes? ¿Quiénes apoyan con recursos y actividades?</span>
                        </label>
                        <input type="text" id="bmc-socios">
                        
                        <label>Estructura de Costes
                            <span class="guide-question">¿Cómo es la estructura de costos? ¿Cuáles son los costos más importantes en la ejecución del modelo?</span>
                        </label>
                        <input type="text" id="bmc-costes">
                    </div>
                </div>

                <div id="ai-feedback-6" class="hidden"></div>
                <button class="btn" onclick="consultAI(6, 'BMC')">Revisar Coherencia Global</button>
            </div>
        </div>

        <!-- FASE 7: RESULTADOS Y PDF -->
        <div id="step-7" class="step-section hidden">
            <div class="card">
                <span class="badge">¡Misión Cumplida!</span>
                <h2>Tu Modelo de Negocio Final</h2>
                <p>Has completado el circuito Crear-Medir-Aprender. Descarga tu lienzo.</p>
                
                <div id="canvas-to-print">
                    <div style="text-align: center; margin-bottom: 20px; color: black; border-bottom: 2px solid #333; padding-bottom: 10px;">
                        <h2 id="print-startup-name">Nombre Startup</h2>
                        <p>Business Model Canvas & Value Proposition - Validado</p>
                    </div>
                    
                    <h3 style="color:black; margin-top:20px;">1. Arquetipo del Cliente</h3>
                    <div style="border:1px solid #ccc; padding:10px; margin-bottom: 20px; color:black;">
                        <p><strong>Demográficos:</strong> <span id="print-arch-demo"></span></p>
                        <p><strong>Psicográficos:</strong> <span id="print-arch-psycho"></span></p>
                        <p><strong>Hábitos:</strong> <span id="print-arch-habits"></span></p>
                    </div>

                    <h3 style="color:black; margin-top:20px;">2. Mapa de Empatía</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom: 20px; color:black;">
                        <div style="border:1px solid #ccc; padding:10px;">
                            <h4>Piensay Siente</h4>
                            <p><span id="print-empathy-think"></span></p>
                        </div>
                        <div style="border:1px solid #ccc; padding:10px;">
                            <h4>Dice y Hace</h4>
                            <p><span id="print-empathy-say"></span></p>
                        </div>
                        <div style="border:1px solid #ccc; padding:10px;">
                            <h4>Ve</h4>
                            <p><span id="print-empathy-see"></span></p>
                        </div>
                        <div style="border:1px solid #ccc; padding:10px;">
                            <h4>Oye</h4>
                            <p><span id="print-empathy-hear"></span></p>
                        </div>
                        <div style="border:1px solid #ccc; padding:10px;">
                            <h4>Dolores</h4>
                            <p><span id="print-empathy-pains"></span></p>
                        </div>
                        <div style="border:1px solid #ccc; padding:10px;">
                            <h4>Ganancias</h4>
                            <p><span id="print-empathy-gains"></span></p>
                        </div>
                    </div>

                    <h3 style="color:black;">3. Value Proposition Canvas</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom: 20px; color:black;">
                        <div style="border:1px solid #ccc; padding:10px; background:#fff;">
                            <h4 style="color:#333;">Perfil del Cliente</h4>
                            <p><strong>Jobs:</strong> <span id="print-jobs"></span></p>
                            <p><strong>Pains:</strong> <span id="print-pains"></span></p>
                            <p><strong>Gains:</strong> <span id="print-gains"></span></p>
                        </div>
                        <div style="border:1px solid #ccc; padding:10px; background:#e3f2fd;">
                            <h4 style="color:#333;">Mapa de Valor</h4>
                            <p><strong>Productos:</strong> <span id="print-prod"></span></p>
                            <p><strong>Aliviadores:</strong> <span id="print-val-pains"></span></p>
                            <p><strong>Creadores:</strong> <span id="print-val-gains"></span></p>
                        </div>
                    </div>

                    <h3 style="color:black;">4. Business Model Canvas</h3>
                    <div id="bmc-preview">
                        <div class="bmc-block bmc-socios"><h4>Socios Clave</h4><ul id="print-socios"></ul></div>
                        <div class="bmc-block bmc-actividades"><h4>Actividades Clave</h4><ul id="print-actividades"></ul></div>
                        <div class="bmc-block bmc-recursos"><h4>Recursos Clave</h4><ul id="print-recursos"></ul></div>
                        <div class="bmc-block bmc-propuesta"><h4>Propuesta de Valor</h4><ul id="print-propuesta"></ul></div>
                        <div class="bmc-block bmc-relaciones"><h4>Relaciones</h4><ul id="print-relaciones"></ul></div>
                        <div class="bmc-block bmc-canales"><h4>Canales</h4><ul id="print-canales"></ul></div>
                        <div class="bmc-block bmc-segmentos"><h4>Segmentos</h4><ul id="print-segmentos"></ul></div>
                        <div class="bmc-block bmc-costes"><h4>Estructura de Costes</h4><ul id="print-costes"></ul></div>
                        <div class="bmc-block bmc-ingresos"><h4>Fuentes de Ingresos</h4><ul id="print-ingresos"></ul></div>
                    </div>
                </div>

                <br>
                <button class="btn" onclick="generatePDF()"><i class="fas fa-file-pdf"></i> Descargar PDF (Horizontal)</button>
                <button class="btn btn-outline" onclick="location.reload()">Nuevo Proyecto</button>
            </div>
        </div>

        <div class="nav-bar">
            <button class="btn btn-outline btn-nav" id="btn-prev" onclick="changeStep(-1)"><i class="fas fa-arrow-left"></i> Anterior</button>
            <button class="btn btn-nav" id="btn-next" onclick="changeStep(1)">Siguiente <i class="fas fa-arrow-right"></i></button>
        </div>
    </div>

    <script>
        let apiKey = '';
        let apiEndpoint = 'https://dashscope-intl.aliyuncs.com/compatible-mode/v1/chat/completions';
        let tokenLimit = 100000;
        let isDemoMode = false;
        
        let tokenStats = { used: 0, calls: 0 };
        
        const challenges = [
            { title: "Escasez de Agua", text: "Imagina que vives en tu ciudad dentro de 5 años. El cambio climático ha hecho que el agua sea muy escasa y cara. La gente está frustrada porque las plantas de sus casas mueren y no pueden cultivar sus propios alimentos." },
            { title: "App Anti-Tabaco", text: "Un grupo de jóvenes quiere lanzar una APP para ayudar a personas fumadoras a dejar el hábito de forma individualizada. Requiere inversión y hay riesgo de que no la usen." },
            { title: "Reciclaje Urbano", text: "Las ciudades están llenas de residuos. Los ciudadanos quieren reciclar pero no saben cómo separar correctamente los materiales. Las empresas necesitan materia prima reciclada de calidad." },
            { title: "Turismo Sostenible", text: "El turismo de masas está destruyendo los centros históricos. Los viajeros buscan experiencias auténticas sin dañar el entorno, pero las agencias tradicionales solo venden paquetes turísticos masivos." },
            { title: "Comida Saludable Rápida", text: "Los estudiantes universitarios comen mal por falta de tiempo y dinero. Quieren comer sano, pero la comida rápida es barata y la saludable es cara y lenta de preparar." }
        ];

        const state = { step: 1, data: {} };

        window.onload = () => {
            const savedKey = localStorage.getItem('qwen_api_key');
            const savedLimit = localStorage.getItem('qwen_token_limit');
            const savedTokens = localStorage.getItem('qwen_token_stats');
            
            if (savedKey) document.getElementById('api-key').value = savedKey;
            if (savedLimit) { document.getElementById('token-limit').value = savedLimit; tokenLimit = parseInt(savedLimit); }
            if (savedTokens) tokenStats = JSON.parse(savedTokens);
        };

        function saveApiKey() {
            const key = document.getElementById('api-key').value;
            const limit = parseInt(document.getElementById('token-limit').value);
            if (key.length < 10) { alert('API Key inválida'); return; }
            apiKey = key; tokenLimit = limit;
            localStorage.setItem('qwen_api_key', key);
            localStorage.setItem('qwen_token_limit', limit);
            startApp();
        }

        function startDemoMode() {
            isDemoMode = true; tokenLimit = 999999; startApp();
        }

        function startApp() {
            document.getElementById('api-setup').classList.add('hidden');
            document.getElementById('game-app').classList.remove('hidden');
            
            const randomChallenge = challenges[Math.floor(Math.random() * challenges.length)];
            document.getElementById('story-content').innerHTML = `
                <h3>${randomChallenge.title}</h3>
                <p>${randomChallenge.text}</p>
                <p><strong>Tu reto:</strong> Crear una startup que solucione esto.</p>
            `;
            
            updateProgress();
            updateTokenDisplay();
            updateNavButtons();
        }

        function changeStep(direction) {
            saveCurrentStepData();
            const newStep = state.step + direction;
            if (newStep >= 1 && newStep <= 7) {
                state.step = newStep;
                document.querySelectorAll('.step-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`step-${state.step}`).classList.remove('hidden');
                updateProgress();
                updateNavButtons();
                if (state.step === 7) renderCanvas();
            }
        }

        function nextStep(step) {
            saveCurrentStepData();
            state.step = step;
            document.querySelectorAll('.step-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step-${step}`).classList.remove('hidden');
            updateProgress();
            updateNavButtons();
            if (step === 7) renderCanvas();
        }

        function updateNavButtons() {
            document.getElementById('btn-prev').style.visibility = state.step === 1 ? 'hidden' : 'visible';
            const nextBtn = document.getElementById('btn-next');
            if (state.step === 7) {
                nextBtn.classList.add('hidden');
            } else {
                nextBtn.classList.remove('hidden');
            }
        }

        function updateProgress() {
            const percent = ((state.step - 1) / 6) * 100;
            document.getElementById('progress').style.width = `${percent}%`;
            const titles = ["El Desafío", "Arquetipo Cliente", "Mapa Empatía", "Perfil Cliente", "Propuesta Valor", "Modelo Canvas", "Final"];
            document.getElementById('step-indicator').innerText = `Fase ${state.step}: ${titles[state.step-1]}`;
        }

        function saveCurrentStepData() {
            if (state.step === 1) state.data.name = document.getElementById('startup-name').value;
            if (state.step === 2) {
                state.data.archAge = document.getElementById('arch-age').value;
                state.data.archEducation = document.getElementById('arch-education').value;
                state.data.archJob = document.getElementById('arch-job').value;
                state.data.archPersonality = document.getElementById('arch-personality').value;
                state.data.archLifestyle = document.getElementById('arch-lifestyle').value;
                state.data.archBuyHow = document.getElementById('arch-buy-how').value;
                state.data.archBuyWhy = document.getElementById('arch-buy-why').value;
                state.data.archNeeds = document.getElementById('arch-needs').value;
                state.data.archExpectations = document.getElementById('arch-expectations').value;
            }
            if (state.step === 3) {
                state.data.empathyThink = document.getElementById('empathy-think').value;
                state.data.empathySay = document.getElementById('empathy-say').value;
                state.data.empathySee = document.getElementById('empathy-see').value;
                state.data.empathyHear = document.getElementById('empathy-hear').value;
                state.data.empathyPains = document.getElementById('empathy-pains').value;
                state.data.empathyGains = document.getElementById('empathy-gains').value;
            }
            if (state.step === 4) {
                state.data.jobs = document.getElementById('cust-jobs').value;
                state.data.pains = document.getElementById('cust-pains').value;
                state.data.gains = document.getElementById('cust-gains').value;
            }
            if (state.step === 5) {
                state.data.valProd = document.getElementById('val-prod').value;
                state.data.valPains = document.getElementById('val-pains').value;
                state.data.valGains = document.getElementById('val-gains').value;
            }
            if (state.step === 6) {
                state.data.bmcSeg = document.getElementById('bmc-segmentos').value;
                state.data.bmcCan = document.getElementById('bmc-canales').value;
                state.data.bmcRel = document.getElementById('bmc-relaciones').value;
                state.data.bmcIng = document.getElementById('bmc-ingresos').value;
                state.data.bmcRec = document.getElementById('bmc-recursos').value;
                state.data.bmcAct = document.getElementById('bmc-actividades').value;
                state.data.bmcSoc = document.getElementById('bmc-socios').value;
                state.data.bmcCos = document.getElementById('bmc-costes').value;
            }
        }

        function toggleInfo(element) {
            element.classList.toggle('active');
        }

        function estimateTokens(text) { return Math.ceil(text.length / 4); }
        function updateTokenStats(inputTokens, outputTokens) {
            tokenStats.used += (inputTokens + outputTokens);
            tokenStats.calls += 1;
            localStorage.setItem('qwen_token_stats', JSON.stringify(tokenStats));
            updateTokenDisplay();
        }
        function updateTokenDisplay() {
            const remaining = Math.max(0, tokenLimit - tokenStats.used);
            const percent = Math.min(100, (tokenStats.used / tokenLimit) * 100);
            document.getElementById('tokens-used').textContent = tokenStats.used.toLocaleString();
            document.getElementById('tokens-remaining').textContent = remaining.toLocaleString();
            document.getElementById('tokens-percent').textContent = percent.toFixed(1) + '%';
            document.getElementById('api-calls').textContent = tokenStats.calls;
        }
        function resetTokenCounter() {
            if(confirm('¿Reiniciar contador?')) {
                tokenStats = { used: 0, calls: 0 };
                localStorage.setItem('qwen_token_stats', JSON.stringify(tokenStats));
                updateTokenDisplay();
            }
        }

        async function consultAI(step, context) {
            saveCurrentStepData();
            const feedbackDiv = document.getElementById(`ai-feedback-${step}`);
            feedbackDiv.classList.remove('hidden');
            feedbackDiv.innerHTML = '<span class="typing-indicator">El mentor está pensando</span>';

            if (isDemoMode) {
                setTimeout(() => {
                    feedbackDiv.innerHTML = '<strong>Modo Simulación:</strong> Tus respuestas parecen coherentes. ¡Sigue adelante!';
                    updateTokenStats(500, 300);
                }, 1000);
                return;
            }

            let systemPrompt = "Eres un mentor de negocios experto en Osterwalder y Lean Startup para alumnos de bachillerato. Tu tono es motivador, breve y usas preguntas socráticas.";
            let userPrompt = "";

            if (context === 'Intro') userPrompt = `El alumno nombra su startup '${state.data.name}' para el desafío. ¿Es un nombre catchy y relacionado?`;
            if (context === 'Archetype') userPrompt = `Arquetipo: Edad:${state.data.archAge}, Educación:${state.data.archEducation}, Personalidad:${state.data.archPersonality}. ¿Está bien definido?`;
            if (context === 'Empathy') userPrompt = `Mapa empatía: Dolores:${state.data.empathyPains}, Ganancias:${state.data.empathyGains}. ¿Hay coherencia?`;
            if (context === 'VPC') userPrompt = `Cliente: Jobs:${state.data.jobs}, Pains:${state.data.pains}, Gains:${state.data.gains}. ¿Están bien definidos?`;
            if (context === 'Propuesta') userPrompt = `Propuesta: ${state.data.valProd}. ¿Hay encaje con los dolores?`;
            if (context === 'BMC') userPrompt = `Canvas: Segmentos:${state.data.bmcSeg}, Ingresos:${state.data.bmcIng}. ¿Es viable?`;

            const inputTokens = estimateTokens(systemPrompt + userPrompt);

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: 'qwen-plus', messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: userPrompt }], max_tokens: 500 })
                });
                const data = await response.json();
                if (data.choices && data.choices.length > 0) {
                    feedbackDiv.innerHTML = `<strong>Mentor IA:</strong> ${data.choices[0].message.content}`;
                    updateTokenStats(inputTokens, estimateTokens(data.choices[0].message.content));
                } else {
                    feedbackDiv.innerHTML = "Error al conectar con el mentor.";
                }
            } catch (error) {
                feedbackDiv.innerHTML = "Error de conexión.";
            }
        }

        function renderCanvas() {
            document.getElementById('print-startup-name').innerText = state.data.name || "Mi Startup";
            document.getElementById('empathy-client-name').innerText = state.data.name ? `CLIENTE DE ${state.data.name.toUpperCase()}` : "CLIENTE OBJETIVO";
            
            const setList = (id, text) => document.getElementById(id).innerHTML = text ? `<li>${text}</li>` : '<li>Pendiente</li>';
            
            // Arquetipo
            document.getElementById('print-arch-demo').innerText = `${state.data.archAge || ''}, ${state.data.archEducation || ''}`;
            document.getElementById('print-arch-psycho').innerText = `${state.data.archPersonality || ''}, ${state.data.archLifestyle || ''}`;
            document.getElementById('print-arch-habits').innerText = `${state.data.archBuyHow || ''}, ${state.data.archBuyWhy || ''}`;
            
            // Empatía
            document.getElementById('print-empathy-think').innerText = state.data.empathyThink;
            document.getElementById('print-empathy-say').innerText = state.data.empathySay;
            document.getElementById('print-empathy-see').innerText = state.data.empathySee;
            document.getElementById('print-empathy-hear').innerText = state.data.empathyHear;
            document.getElementById('print-empathy-pains').innerText = state.data.empathyPains;
            document.getElementById('print-empathy-gains').innerText = state.data.empathyGains;
            
            // VPC
            document.getElementById('print-jobs').innerText = state.data.jobs;
            document.getElementById('print-pains').innerText = state.data.pains;
            document.getElementById('print-gains').innerText = state.data.gains;
            document.getElementById('print-prod').innerText = state.data.valProd;
            document.getElementById('print-val-pains').innerText = state.data.valPains;
            document.getElementById('print-val-gains').innerText = state.data.valGains;

            // BMC
            setList('print-segmentos', state.data.bmcSeg);
            setList('print-canales', state.data.bmcCan);
            setList('print-relaciones', state.data.bmcRel);
            setList('print-ingresos', state.data.bmcIng);
            setList('print-recursos', state.data.bmcRec);
            setList('print-actividades', state.data.bmcAct);
            setList('print-socios', state.data.bmcSoc);
            setList('print-costes', state.data.bmcCos);
            setList('print-propuesta', state.data.valProd);
        }

        function generatePDF() {
            const element = document.getElementById('canvas-to-print');
            element.style.background = "white";
            element.style.color = "black";
            document.querySelectorAll('.bmc-block').forEach(b => {
                b.style.background = "#f9f9f9";
                b.style.color = "black";
                b.querySelector('h4').style.color = "#333";
            });

            const opt = {
                margin: 0.5,
                filename: `${state.data.name || 'modelo'}_canvas.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
            };
            
            html2pdf().set(opt).from(element).save().then(() => {
                alert("¡PDF generado en horizontal!");
            });
        }
    </script>
</body>
</html>